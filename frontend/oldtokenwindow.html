<!DOCTYPE html>
<html>
    <head>
        <title>Истёк срок сессии</title>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    </head>

    <body>
        <h1>Срок сессии истёк</h1>
        <div id="app">
            <p id="username"></p>
            <p id="token"></p>
            <h2>Время последнего входа:</h2>
            <p id="authDatestr"></p>
            <div>
                <h2>Войти через пароль</h2>
                <input v-model="password"><br>
                <button @click="login">Подтвердить</button>
            </div>
            <br>
            <button @click="logout">Выход</button>
        </div>

        <script>
            const { createApp, ref } = Vue;
            createApp({
                setup() {                   
                    const password = ref('');
                    const login = async () => {                                      
                        const urlparams = new URLSearchParams(window.location.search);
                        const username = urlparams.get('username');
                        const passwd = password.value.trim();
                        if (!username || !passwd)
                        {
                            alert('error');
                            return;
                        }
                        try 
                        {
                            const url = `http://localhost:3000/auth?username=${encodeURIComponent(username)}&userpswd=${encodeURIComponent(passwd)}`;
                            const res = await fetch(url);
                            const text = await res.text();
                            if (res.ok)
                            {
                                const tokenMatch = text.match(/Token:\s*(\S+)/);
                                const authDateMatch = text.match(/AuthDate:\s*(\S+)/);
                                const token = tokenMatch ? tokenMatch[1] : '';
                                const authDate = authDateMatch ? authDateMatch[1] : '';
                                if (token && authDate) {
                                    const params = new URLSearchParams({
                                        username: username,
                                        token: token,
                                        authDate: authDate
                                        });
                                    window.location.href = `main.html?${params.toString()}`;                                
                                }
                                else
                                {
                                    alert('responce error');
                                } 
                            }
                            else
                            {
                                alert(`error ${res.status} - ${text || res.statusText}`);
                            }
                        } catch (err) {
                            console.error('error', err);
                            alert('no conection');
                        }
                    };
                    const logout = async () => {   
                        window.location.href = 'index.html';
                    };
                    return {password, login, logout};
                }
            }).mount('#app');
        </script>
        <script>
            const urlparams = new URLSearchParams(window.location.search);
            const username = urlparams.get('username');
            const token = urlparams.get('token');
            const authDatestr = urlparams.get('authDatestr');
            document.getElementById('username').textContent = username ? `user: ${username}` : 'none';
            document.getElementById('token').textContent = token ? `token: ${token}` : 'none';
            document.getElementById('authDatestr').textContent = authDatestr ? new Date(Number(authDatestr)).toLocaleString() : '-';
        </script>
    </body>

    <style>
        body 
        {
            margin: 0;
            color: goldenrod;
            background-color: rgb(56, 54, 54);
            font-size: 32px;
            justify-content: center;
            justify-items: center;
        }
        button 
        {
            background-color: aqua;
            width: 177px;
            justify-content: center;
            justify-items: center;
        }
        h2 
        {
            color: blueviolet;
            font-size: 24px;
        }
        p 
        {
            font-size: 24px;
            word-break: break-all;
        }
        input
        {
            background-color: aquamarine;
            color: rgb(0, 0, 0);
        }
    </style>
</html>